<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-API Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --anti-blue: #4796E3;
            --anti-purple: #6b4da3;
            --copilot-red: #f85149;
            --claude-orange: #DA7756;
            --white-glow: #ffffff;
            --dark-purple: #3b2a54;
            --pure-black: #000000;
            --warm-dark: #262624;
        }

        body {
            background: var(--pure-black);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        @media (prefers-color-scheme: light) {
            body {
                background: var(--warm-dark);
            }
        }

        @media (prefers-color-scheme: light) {
            .card-inner {
                background: rgba(50, 50, 48, 0.9);
            }

            .refresh-btn button,
            .refresh-btn a {
                background: rgba(50, 50, 48, 0.9);
            }

            #copy-toast {
                background: rgba(50, 50, 48, 0.95);
            }

            .bg-gray-900 {
                background-color: rgba(30, 30, 28, 0.8) !important;
            }
        }



        .card-3d {
            perspective: 1000px;
        }

        .card-inner {
            transform-style: preserve-3d;
            transition: box-shadow 0.3s ease, background 0.3s ease, border-color 0.3s ease;
            background: rgba(17, 17, 17, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 42, 84, 0.3);
        }

        /* Antigravity - ËìùÁ¥´Ëâ≤ËÉåÊôØÂÖâÊôï */
        .card-3d[data-provider="antigravity"].active .card-inner {
            background: rgba(71, 150, 227, 0.16);
            border-color: var(--anti-blue);
            animation: antigravity-breathe 2s ease-in-out infinite;
        }

        @keyframes antigravity-breathe {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(71, 150, 227, 0.45),
                    0 0 40px rgba(107, 77, 163, 0.25);
            }

            50% {
                box-shadow: 0 0 36px rgba(71, 150, 227, 0.7),
                    0 0 70px rgba(107, 77, 163, 0.4);
            }
        }

        /* Codex - ÁôΩËâ≤ËÉåÊôØÂÖâÊôï */
        .card-3d[data-provider="codex"].active .card-inner {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--white-glow);
            animation: codex-breathe 2s ease-in-out infinite;
        }

        @keyframes codex-breathe {

            0%,
            100% {
                box-shadow: 0 0 18px rgba(255, 255, 255, 0.35),
                    0 0 36px rgba(255, 255, 255, 0.15);
            }

            50% {
                box-shadow: 0 0 32px rgba(255, 255, 255, 0.65),
                    0 0 60px rgba(255, 255, 255, 0.35);
            }
        }

        /* Copilot - Á∫¢Ëâ≤ËÉåÊôØÂÖâÊôï */
        .card-3d[data-provider="copilot"].active .card-inner {
            background: rgba(248, 81, 73, 0.14);
            border-color: var(--copilot-red);
            animation: copilot-breathe 2s ease-in-out infinite;
        }

        @keyframes copilot-breathe {

            0%,
            100% {
                box-shadow: 0 0 18px rgba(248, 81, 73, 0.35),
                    0 0 38px rgba(248, 81, 73, 0.2);
            }

            50% {
                box-shadow: 0 0 34px rgba(248, 81, 73, 0.65),
                    0 0 68px rgba(248, 81, 73, 0.35);
            }
        }

        @keyframes claude-breathe {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(218, 119, 86, 0.4),
                    0 0 40px rgba(218, 119, 86, 0.2);
            }

            50% {
                box-shadow: 0 0 35px rgba(218, 119, 86, 0.7),
                    0 0 70px rgba(218, 119, 86, 0.4);
            }
        }

        /* Refresh ÊåâÈíÆ - ÁôΩËâ≤ÈúìËôπ */
        .refresh-btn {
            perspective: 1000px;
        }

        .refresh-btn button {
            transform-style: preserve-3d;
            transition: box-shadow 0.3s ease, background 0.3s ease, border-color 0.3s ease;
            background: rgba(17, 17, 17, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 42, 84, 0.3);
        }

        /* Log out ÊåâÈíÆ - Claude Ê©ôËâ≤ÈúìËôπ */
        #logout-container.active button {
            background: rgba(218, 119, 86, 0.15);
            border-color: var(--claude-orange);
            backdrop-filter: blur(20px);
            animation: claude-breathe 2s ease-in-out infinite;
        }

        /* Remote ÊåâÈíÆ - Antigravity ËìùËâ≤ÈúìËôπ */
        #remote-btn:hover {
            background: rgba(71, 150, 227, 0.15);
            border-color: var(--anti-blue);
            backdrop-filter: blur(20px);
            box-shadow: 0 0 20px rgba(71, 150, 227, 0.4),
                0 0 40px rgba(71, 150, 227, 0.2);
        }

        /* Refresh ÊåâÈíÆ - ÁôΩËâ≤ÈúìËôπ */
        #refresh-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--white-glow);
            backdrop-filter: blur(20px);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4),
                0 0 40px rgba(255, 255, 255, 0.2);
        }

        /* Routing ÊåâÈíÆ - Á¥´Ëâ≤ÈúìËôπ */
        #routing-btn:hover {
            background: rgba(107, 77, 163, 0.18);
            border-color: var(--anti-purple);
            backdrop-filter: blur(20px);
            box-shadow: 0 0 20px rgba(107, 77, 163, 0.45),
                0 0 42px rgba(107, 77, 163, 0.25);
        }

        /* Add ÊåâÈíÆ - ÁªøËâ≤ÈúìËôπ */
        #add-account-btn:hover {
            background: rgba(34, 197, 94, 0.18);
            border-color: rgba(34, 197, 94, 0.7);
            backdrop-filter: blur(20px);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.45),
                0 0 42px rgba(34, 197, 94, 0.25);
        }

        .progress-bar {
            background: white;
            transition: all 0.3s ease;
        }

        .antigravity-bar {
            background: linear-gradient(90deg, var(--anti-blue), var(--anti-purple));
            box-shadow: 0 0 14px rgba(71, 150, 227, 0.6);
        }

        .codex-bar {
            background: linear-gradient(90deg, #ffffff, #d9d9d9);
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.7);
        }

        .copilot-bar {
            background: linear-gradient(90deg, #f85149, #ff938b);
            box-shadow: 0 0 12px rgba(248, 81, 73, 0.6);
        }

        .loading-screen {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, rgba(71, 150, 227, 0.12), transparent 45%),
                #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.3s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-box {
            background: rgba(17, 17, 17, 0.9);
            border: 1px solid rgba(59, 42, 84, 0.5);
            border-radius: 20px;
            padding: 28px 36px;
            text-align: center;
            box-shadow: 0 0 30px rgba(71, 150, 227, 0.25);
        }

        .loading-spinner {
            width: 42px;
            height: 42px;
            border-radius: 999px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-top-color: var(--anti-blue);
            margin: 0 auto 14px;
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen p-6">
    <div id="loading-screen" class="loading-screen">
        <div class="loading-box">
            <div class="loading-spinner"></div>
            <div class="text-sm text-gray-200 font-semibold">loading...hell the world...</div>
        </div>
    </div>
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-300">Anti-API Quotas Dashboard</h1>
                <p id="plan-info" class="text-gray-500 text-sm font-bold mt-1">Loading...</p>
                <div id="copy-toast"
                    class="fixed bottom-32 right-8 bg-gray-800 text-gray-300 px-4 py-2 rounded-lg text-sm opacity-0 translate-x-8 transition-all duration-300 pointer-events-none z-50">
                    Copied!</div>
            </div>
            <div class="text-right">
                <div class="flex items-center gap-3 justify-end">
                    <div class="refresh-btn inline-block">
                        <button onclick="window.open('/remote-panel', '_blank')" id="remote-btn"
                            class="px-4 py-1.5 rounded-lg font-bold text-gray-300 text-sm">
                            Remote
                        </button>
                    </div>
                    <div class="refresh-btn inline-block">
                        <button onclick="window.location.href='/routing'" id="routing-btn"
                            class="px-4 py-1.5 rounded-lg font-bold text-gray-300 text-sm">
                            Routing(Beta)
                        </button>
                    </div>
                    <div class="refresh-btn inline-block" id="add-account-container">
                        <button onclick="openAddAccountModal()" id="add-account-btn"
                            class="px-4 py-1.5 rounded-lg font-bold text-green-400 text-sm">
                            Add
                        </button>
                    </div>
                    <div class="refresh-btn inline-block" id="refresh-container">
                        <button onclick="refreshAll(true)" id="refresh-btn"
                            class="px-4 py-1.5 rounded-lg font-bold text-gray-300 text-sm">
                            Refresh
                        </button>
                    </div>

                </div>
                <p id="last-updated" class="text-gray-600 text-xs mt-2"></p>
            </div>
        </div>

        <!-- Quota Grid -->
        <div id="quota-grid" class="space-y-6">
            <!-- Loading placeholder -->
            <div class="grid grid-cols-3 gap-4">
                <div class="card-3d">
                    <div class="card-inner rounded-lg p-4 animate-pulse">
                        <div class="h-3 bg-gray-800 rounded w-1/2 mb-3"></div>
                        <div class="h-6 bg-gray-800 rounded w-2/3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-gray-600 text-xs">
            ¬© 2025 <a href="https://github.com/silas" target="_blank"
                class="hover:text-gray-400 transition-colors">Silas</a> ¬∑ <a href="https://github.com/silas/anti-api"
                target="_blank" class="hover:text-gray-400 transition-colors">github.com/silas/anti-api</a>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="add-account-modal"
        class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-[#111111] border border-[#2f253f] rounded-2xl w-full max-w-md p-6 text-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold">Add Account</h2>
                <button onclick="closeAddAccountModal()" class="text-gray-500 hover:text-gray-300">‚úï</button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Choose a provider to authenticate.</p>
            <div class="space-y-2">
                <button class="w-full text-left px-4 py-3 rounded-lg border border-[#2f253f] hover:border-gray-500"
                    onclick="startProviderLogin('antigravity')">
                    Antigravity (OAuth)
                </button>
                <button class="w-full text-left px-4 py-3 rounded-lg border border-[#2f253f] hover:border-gray-500"
                    onclick="startProviderLogin('codex')">
                    Codex (OAuth / Import)
                </button>
                <button class="w-full text-left px-4 py-3 rounded-lg border border-[#2f253f] hover:border-gray-500"
                    onclick="startProviderLogin('copilot')">
                    GitHub Copilot (Device Code)
                </button>
            </div>
            <div id="add-account-status" class="mt-4 text-xs text-gray-400 hidden"></div>
            <div id="codex-fallback" class="mt-3 text-xs text-gray-400 hidden">
                If the Codex page is blank, open this link:
                <a id="codex-fallback-link" href="#" target="_blank"
                    class="text-blue-400 hover:text-blue-300 ml-1">Alt authorize</a>
            </div>
            <div id="copilot-device" class="mt-4 hidden">
                <div class="text-sm text-gray-400 mb-2">Open the browser and enter this code:</div>
                <div class="flex items-center gap-2">
                    <div id="copilot-code"
                        class="px-3 py-2 rounded-lg bg-black border border-[#2f253f] font-mono text-sm text-gray-200">
                        ------
                    </div>
                    <button onclick="copyCopilotCode()"
                        class="px-3 py-2 rounded-lg border border-[#2f253f] text-xs hover:border-gray-500">
                        Copy
                    </button>
                </div>
                <a id="copilot-link" href="#" target="_blank"
                    class="inline-block mt-3 text-blue-400 hover:text-blue-300 text-xs">Open verification page</a>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8964';
        let loadingDismissed = false;

        // 3D ÂÄæÊñúÊïàÊûú
        function init3DEffect() {
            // Âç°ÁâáÊïàÊûú
            document.querySelectorAll('.card-3d').forEach(card => {
                const inner = card.querySelector('.card-inner');

                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;

                    // ËÆ°ÁÆóÊóãËΩ¨ËßíÂ∫¶ (ÊúÄÂ§ß 15 Â∫¶)
                    const rotateX = ((y - centerY) / centerY) * -15;
                    const rotateY = ((x - centerX) / centerX) * 15;

                    inner.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                    card.classList.add('active');
                });

                card.addEventListener('mouseleave', () => {
                    inner.style.transform = 'rotateX(0) rotateY(0)';
                    card.classList.remove('active');
                });
            });

            // Refresh ÊåâÈíÆÊïàÊûú
            const refreshContainer = document.getElementById('refresh-container');
            const refreshBtn = document.getElementById('refresh-btn');

            if (refreshContainer && refreshBtn) {
                refreshContainer.addEventListener('mousemove', (e) => {
                    const rect = refreshContainer.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;

                    const rotateX = ((y - centerY) / centerY) * -10;
                    const rotateY = ((x - centerX) / centerX) * 10;

                    refreshBtn.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                    refreshContainer.classList.add('active');
                });

                refreshContainer.addEventListener('mouseleave', () => {
                    refreshBtn.style.transform = 'rotateX(0) rotateY(0)';
                    refreshContainer.classList.remove('active');
                });
            }

            // Log out ÊåâÈíÆÊïàÊûú
            const logoutContainer = document.getElementById('logout-container');
            const logoutBtn = document.getElementById('logout-btn');

            if (logoutContainer && logoutBtn) {
                logoutContainer.addEventListener('mousemove', (e) => {
                    const rect = logoutContainer.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;

                    const rotateX = ((y - centerY) / centerY) * -10;
                    const rotateY = ((x - centerX) / centerX) * 10;

                    logoutBtn.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                    logoutContainer.classList.add('active');
                });

                logoutContainer.addEventListener('mouseleave', () => {
                    logoutBtn.style.transform = 'rotateX(0) rotateY(0)';
                    logoutContainer.classList.remove('active');
                });
            }
        }

        function formatResetTime(resetTime) {
            const now = new Date();
            const reset = new Date(resetTime);
            const diffMs = reset - now;

            if (diffMs <= 0) return 'Resetting...';

            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        function showToast(message) {
            const toast = document.getElementById('copy-toast');
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-x-8');
            toast.classList.add('opacity-100', 'translate-x-0');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-x-0');
                toast.classList.add('opacity-0', 'translate-x-8');
            }, 2000);
        }

        function copyModelId(modelId) {
            navigator.clipboard.writeText(modelId);
            showToast(`Copied: ${modelId}`);
        }

        function renderAccountCard(account) {
            const provider = account.provider || 'antigravity';
            const bars = account.bars || [];
            const cardId = `${provider}-${account.accountId}`;

            const barHtml = bars.map(bar => {
                const percentage = Math.max(0, Math.min(100, Math.round(bar.percentage || 0)));
                return `
                    <div class="space-y-1">
                        <div class="flex items-center justify-between text-xs text-gray-400">
                            <span class="uppercase tracking-widest">${bar.label}</span>
                            <span class="font-bold text-gray-300">${percentage}%</span>
                        </div>
                        <div class="h-2 bg-gray-900 rounded-full overflow-hidden">
                            <div class="progress-bar h-full rounded-full transition-all ${provider}-bar"
                                 style="width: ${percentage}%;"></div>
                        </div>
                        <div class="text-[10px] text-gray-500">${bar.resetTime ? formatResetTime(bar.resetTime) : '‚Äî'}</div>
                    </div>
                `;
            }).join('');

            return `
                <div class="card-3d" data-provider="${provider}" data-card-id="${cardId}">
                    <div class="card-inner rounded-2xl p-5">
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-sm font-bold text-gray-200">${account.displayName || account.accountId}</div>
                            <span class="text-[10px] text-gray-500 uppercase tracking-[0.2em]">${provider}</span>
                        </div>
                        <div class="space-y-4">${barHtml}</div>
                    </div>
                </div>
            `;
        }

        async function fetchQuota(showToastMsg = false) {
            try {
                const response = await fetch(`${API_BASE}/quota/json`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('quota-grid').innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-gray-400 mb-2">üìä ÈÖçÈ¢ùËØ¶ÊÉÖ‰∏çÂèØÁî®</p>
                            <p class="text-gray-600 text-sm">ÈúÄË¶ÅÂÆåÊàêËÆ§ËØÅÊàñÈÖçÈ¢ùÊé•Âè£ÂèØÁî®</p>
                        </div>
                    `;
                    return;
                }

                const accounts = data.accounts || [];
                const planInfo = document.getElementById('plan-info');
                planInfo.innerHTML = `<span class="text-gray-300">${accounts.length} account(s)</span> <span class="text-gray-600 text-xs">‚Ä¢ Multi-provider quota view</span>`;

                if (showToastMsg) {
                    showToast('Refreshed!');
                }

                const grid = document.getElementById('quota-grid');
                if (accounts.length === 0) {
                    grid.innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-gray-400 mb-2">No accounts yet</p>
                            <p class="text-gray-600 text-sm">Add accounts to see quota cards</p>
                        </div>
                    `;
                } else {
                    grid.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        ${accounts.map(renderAccountCard).join('')}
                    </div>`;
                }

                init3DEffect();

                document.getElementById('last-updated').innerHTML =
                    `Last updated: <span class="font-bold text-gray-300">${new Date().toLocaleTimeString()}</span>`;

            } catch (error) {
                document.getElementById('plan-info').innerHTML =
                    `<span class="text-gray-300">Connection failed</span>`;
                document.getElementById('quota-grid').innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-gray-500 mb-4">Unable to connect to ${API_BASE}</p>
                        <button onclick="fetchQuota()" 
                                class="px-6 py-2 rounded-lg font-bold text-gray-300"
                                style="background: var(--dark-purple);">
                            Retry
                        </button>
                    </div>
                `;
            } finally {
                hideLoadingOnce();
            }
        }

        // ÈößÈÅìÁä∂ÊÄÅÂèòÈáè
        let tunnelUrl = null;

        // Ê£ÄÊü•ÈößÈÅìÁä∂ÊÄÅ
        async function checkTunnelStatus() {
            try {
                const response = await fetch(`${API_BASE}/tunnel/status`);
                const data = await response.json();

                const tunnelContainer = document.getElementById('tunnel-container');

                if (data.active && data.url) {
                    tunnelUrl = data.url;
                    tunnelContainer.style.display = 'block';
                } else {
                    tunnelUrl = null;
                    tunnelContainer.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to check tunnel status:', error);
            }
        }

        // Â§çÂà∂ÈößÈÅì URL
        async function copyTunnelUrl() {
            if (!tunnelUrl) return;

            try {
                await navigator.clipboard.writeText(tunnelUrl);

                // ÊòæÁ§∫Â§çÂà∂ÊàêÂäüÊèêÁ§∫
                const toast = document.getElementById('copy-toast');
                toast.textContent = `Copied: ${tunnelUrl}`;
                toast.classList.remove('opacity-0', 'translate-x-8');

                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-x-8');
                }, 2000);
            } catch (error) {
                alert(`Failed to copy: ${tunnelUrl}`);
            }
        }

        // Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅÂπ∂Êõ¥Êñ∞ÊåâÈíÆÊòæÁ§∫
        async function checkAuthStatus() {
            try {
                const response = await fetch(`${API_BASE}/auth/status`);
                const data = await response.json();

                const logoutContainer = document.getElementById('logout-container');

                if (data.authenticated) {
                    if (logoutContainer) {
                        logoutContainer.style.display = 'block';
                    }
                } else {
                    if (logoutContainer) {
                        logoutContainer.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to check auth status:', error);
            }
        }

        function hideLoadingOnce() {
            if (loadingDismissed) return;
            const loading = document.getElementById('loading-screen');
            loading.classList.add('hidden');
            loadingDismissed = true;
            setTimeout(() => loading.remove(), 400);
        }

        function openAddAccountModal() {
            document.getElementById('add-account-modal').classList.remove('hidden');
            document.getElementById('add-account-modal').classList.add('flex');
            document.getElementById('add-account-status').classList.add('hidden');
            document.getElementById('copilot-device').classList.add('hidden');
            document.getElementById('codex-fallback').classList.add('hidden');
        }

        function closeAddAccountModal() {
            document.getElementById('add-account-modal').classList.add('hidden');
            document.getElementById('add-account-modal').classList.remove('flex');
        }

        function setAddAccountStatus(message) {
            const status = document.getElementById('add-account-status');
            status.textContent = message;
            status.classList.remove('hidden');
        }

        async function startProviderLogin(provider) {
            setAddAccountStatus('Starting authentication...');

            try {
                const payload = { provider };
                if (provider === 'codex' || provider === 'copilot') {
                    payload.force = true;
                }
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (!data.success) {
                    setAddAccountStatus(data.error || 'Authentication failed');
                    return;
                }

                if (provider === 'copilot') {
                    if (data.status === 'success' && data.source === 'import') {
                        setAddAccountStatus(`Imported Copilot: ${data.login || 'Copilot'}`);
                        await checkAuthStatus();
                        return;
                    }
                    showCopilotDeviceFlow(data);
                    return;
                }

                if (provider === 'codex' && data.status === 'pending') {
                    if (data.auth_url) {
                        window.open(data.auth_url, '_blank');
                    }
                    const fallbackWrap = document.getElementById('codex-fallback');
                    const fallbackLink = document.getElementById('codex-fallback-link');
                    if (data.auth_url_fallback && fallbackWrap && fallbackLink) {
                        fallbackLink.href = data.auth_url_fallback;
                        fallbackWrap.classList.remove('hidden');
                    }
                    setAddAccountStatus('Waiting for Codex authorization...');
                    pollCodexStatus(data.state);
                    return;
                }

                if (provider === 'codex' && data.source === 'import') {
                    setAddAccountStatus(`Imported Codex: ${data.email || data.id || 'Codex'}`);
                } else {
                    setAddAccountStatus(`Connected: ${data.email || data.id || provider}`);
                }
                await checkAuthStatus();
                fetchQuota(true);
            } catch (error) {
                setAddAccountStatus(`Authentication error: ${error.message}`);
            }
        }

        function showCopilotDeviceFlow(data) {
            const device = document.getElementById('copilot-device');
            const codeEl = document.getElementById('copilot-code');
            const linkEl = document.getElementById('copilot-link');
            device.classList.remove('hidden');
            codeEl.textContent = data.user_code || '----';
            linkEl.href = data.verification_uri || '#';
            if (data.verification_uri) {
                window.open(data.verification_uri, '_blank');
            }
            setAddAccountStatus('Waiting for GitHub Copilot authorization...');
            pollCopilotStatus(data.device_code, data.interval || 5);
        }

        async function pollCopilotStatus(deviceCode, intervalSeconds) {
            if (!deviceCode) return;
            const status = await fetch(`${API_BASE}/auth/copilot/status?device_code=${deviceCode}`);
            const data = await status.json();
            if (data.status === 'success') {
                setAddAccountStatus(`Connected: ${data.account?.login || 'Copilot'}`);
                await checkAuthStatus();
                return;
            }
            if (data.status === 'error') {
                setAddAccountStatus(data.message || 'Copilot authentication failed');
                return;
            }
            setTimeout(() => pollCopilotStatus(deviceCode, intervalSeconds), intervalSeconds * 1000);
        }

        function copyCopilotCode() {
            const code = document.getElementById('copilot-code').textContent;
            navigator.clipboard.writeText(code || '');
            showToast(`Copied: ${code}`);
        }

        async function pollCodexStatus(state) {
            if (!state) return;
            const status = await fetch(`${API_BASE}/auth/codex/status?state=${state}`);
            const data = await status.json();
            if (data.status === 'success') {
                setAddAccountStatus(`Connected: ${data.account?.email || 'Codex'}`);
                await checkAuthStatus();
                return;
            }
            if (data.status === 'error') {
                setAddAccountStatus(data.message || 'Codex authentication failed');
                return;
            }
            setTimeout(() => pollCodexStatus(state), 2000);
        }

        // ÁôªÂá∫Â§ÑÁêÜ
        async function handleLogout() {
            try {
                const response = await fetch(`${API_BASE}/auth/logout`, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert('Logged out successfully');
                    await checkAuthStatus();
                }
            } catch (error) {
                alert(`Logout error: ${error.message}`);
            }
        }

        // Initial load
        refreshAll(false);
        init3DEffect();

        // Auto refresh every 60 seconds
        setInterval(() => {
            refreshAll(false);
        }, 60000);

        async function refreshAll(showToastMsg = false) {
            await Promise.all([
                fetchQuota(showToastMsg),
                checkAuthStatus(),
                checkTunnelStatus(),
            ]);
        }
    </script>
</body>

</html>
